<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ (v5 - Ù†Ù‡Ø§Ø¦ÙŠ)</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: #0b0f14;
      color: #e9eef5;
      margin: 0;
      padding: 20px;
    }
    
    h1 {
      margin-bottom: 16px;
      font-size: 1.4rem;
      color: #fff;
    }
    
    .card {
      background: #121822;
      border: 1px solid #1e2a3a;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, .35);
    }
    
    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 6px;
      font-size: .9rem;
      color: #cbd5e1;
    }
    
    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #2a3a52;
      background: #0f141c;
      color: #e9eef5;
    }
    
    textarea {
      min-height: 84px;
      resize: vertical;
    }
    
    button {
      padding: 8px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: opacity .2s;
    }
    
    button:hover {
      opacity: .9;
    }
    
    .danger {
      background: #ef4444;
      color: #fff;
    }
    
    .primary {
      background: #1e90ff;
      color: #fff;
    }
    
    .ghost {
      background: transparent;
      border: 1px solid #2a3a52;
      color: #cbd5e1;
    }
    
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #132032;
      color: #9cc2ff;
      font-size: .85rem;
    }
    
    .totals {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    
    .totals div {
      background: #0f141c;
      border: 1px solid #1f2a3a;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .row > div {
      margin-left: 15px;
      margin-right: 15px;
    }
    
    .muted {
      color: #9fb1cc;
      font-size: .9rem;
    }
    
    table.main-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      margin-top: 10px;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    th,
    td {
      text-align: center;
      padding: 12px;
    }
    
    .main-table th,
    .main-table td {
      min-width: 120px;
    }
    
    thead th {
      background: #1a2230;
      color: #cbd5e1;
      font-weight: 600;
    }
    
    tbody tr {
      background: #0f141c;
      border: 1px solid #1f2a3a;
    }
    
    tbody td {
      border-top: 1px solid #1f2a3a;
    }
    
    .col-planned,
    td.col-planned {
      min-width: 130px;
    }
    
    .col-paid,
    td.col-paid {
      min-width: 130px;
    }
    
    .col-due,
    td.col-due {
      min-width: 140px;
    }
    
    .main-table td input[type='number'] {
      width: 120px;
    }
    
    .main-table td input[type='text'] {
      width: 160px;
    }
    
    .status {
      font-weight: 700;
    }
    
    .status.Ù…Ø¯ÙÙˆØ¹ {
      color: #22c55e;
    }
    
    .status.Ù…Ø¯ÙÙˆØ¹-Ø¬Ø²Ø¦ÙŠ {
      color: #facc15;
    }
    
    .status.ØºÙŠØ±-Ù…Ø¯ÙÙˆØ¹ {
      color: #1e90ff;
    }
    
    .status.Ø¯Ø®Ù„ {
      color: #60a5fa;
    }
    
    .sub-table {
      margin-top: 8px;
      border: 1px solid #2a3a52;
      border-radius: 10px;
      width: 100%;
    }
    
    .sub-table th {
      background: #1a2230;
      color: #9cc2ff;
    }
    
    .sub-table td {
      background: #141c26;
    }
    
    #history-chart-wrap {
      height: 260px;
      position: relative;
      margin-top: 16px;
    }
    
    #delta-chart-wrap {
      height: 240px;
      position: relative;
      margin-top: 16px;
    }
    
    #history-chart,
    #delta-chart {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }
  </style>

  <style id="mobile-v29">
    @media (max-width: 430px) {
      html,
      body {
        margin: 0;
        padding: 10px;
        width: 100%;
        max-width: 100vw;
        overflow-x: hidden;
      }
      #extras-table thead {
        display: none;
      }
      #extras-rows tr {
        display: grid;
        grid-template-columns: 1fr 90px auto;
        gap: 10px;
        width: 100%;
        margin: 10px auto;
        padding: 15px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        align-items: center;
      }
      #extras-rows td {
        border: none;
        padding: 0;
        text-align: right;
        min-width: 0;
      }
      #extras-rows td:nth-child(1) {
        font-weight: bold;
        color: #fff;
        overflow-wrap: break-word;
      }
      #investments-table thead {
        display: none;
      }
      #inv-rows tr {
        display: grid;
        width: 100%;
        margin: 10px auto;
        padding: 15px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        gap: 10px;
        grid-template-columns: 1fr 1fr;
        grid-template-areas: "type   dest""amount source""notes  notes""delete delete";
      }
      #inv-rows td {
        border: none;
        padding: 0;
        min-width: 0;
      }
      #inv-rows td:nth-child(1) {
        grid-area: type;
      }
      #inv-rows td:nth-child(2) {
        grid-area: dest;
      }
      #inv-rows td:nth-child(3) {
        grid-area: amount;
      }
      #inv-rows td:nth-child(4) {
        grid-area: source;
      }
      #inv-rows td:nth-child(5) {
        display: none;
      }
      #inv-rows td:nth-child(6) {
        grid-area: notes;
      }
      #inv-rows td:nth-child(7) {
        grid-area: delete;
      }
      #inv-rows input,
      #inv-rows textarea {
        width: 100%;
      }
      #inv-rows td:nth-child(7) button {
        width: 100%;
      }
      #rows {
        width: 100%;
        border-spacing: 0;
        border-collapse: separate;
        direction: rtl;
      }
      #rows tr {
        display: grid;
        width: 100%;
        margin: 10px auto;
        grid-template-areas: "name   planned""paid   due""status actions""detailsInput detailsToggle""detailsPanel detailsPanel";
        grid-template-columns: 1fr 1fr;
        column-gap: 10px;
        row-gap: 6px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØ±Ø§Øº Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ */
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 10px 12px;
        align-items: start;
        overflow: hidden;
      }
      #rows thead,
      #rows th {
        display: none !important;
      }
      #rows td:nth-child(1) {
        grid-area: name;
      }
      #rows td:nth-child(2) {
        grid-area: planned;
      }
      #rows td:nth-child(3) {
        grid-area: paid;
      }
      #rows td:nth-child(4) {
        grid-area: due;
      }
      #rows td:nth-child(5) {
        grid-area: status;
      }
      #rows td:nth-child(6) {
        grid-area: actions;
      }
      #rows td {
        position: relative;
        padding: 4px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´ÙˆØ© */
        min-width: 0;
      }
      #rows td::before {
        display: block;
        font-size: 0.9rem;
        font-weight: 700;
        opacity: .95;
        margin-bottom: 4px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© */
        line-height: 1.15;
        color: #fff;
        text-align: center;
      }
      #rows td:nth-child(1)::before {
        content: "Ø§Ù„Ù…ØµØ±ÙˆÙ";
      }
      #rows td:nth-child(2)::before {
        content: "Ø§Ù„Ù…Ø®Ø·Ø·";
      }
      #rows td:nth-child(3)::before {
        content: "Ø§Ù„Ù…Ø¯ÙÙˆØ¹";
      }
      #rows td:nth-child(4)::before {
        content: "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ";
      }
      #rows td:nth-child(5)::before {
        content: "Ø§Ù„Ø­Ø§Ù„Ø©";
      }
      #rows td:nth-child(6)::before {
        content: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª";
      }
      #rows input,
      #rows select,
      #rows textarea {
        width: 100%;
        max-width: 100%;
        padding: 8px 10px;
        min-width: 0;
      }
      #rows td:nth-child(1),
      #rows td:nth-child(2),
      #rows td:nth-child(3),
      #rows td:nth-child(4) {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      #rows td:nth-child(1) input {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
      }
      #rows td:nth-child(2) input,
      #rows td:nth-child(3) input,
      #rows td:nth-child(4) input {
        width: 100%;
        max-width: 100%;
        text-align: end;
        margin: 0 auto;
      }
      #rows td:nth-child(6) {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        text-align: center;
      }
      .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        width: 100%;
      }
      #rows td:nth-child(6) .btn,
      #rows td:nth-child(6) button {
        padding: 8px 10px;
        line-height: 1.2;
        font-size: 0.95rem;
      }
      #rows td:nth-child(6) .is-details-btn {
        display: none !important;
      }
      #rows td.mobile-details-input::before {
        content: "Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„";
        text-align: center;
        width: 100%;
      }
      #rows td.mobile-details-toggle::before {
        content: "Ø§Ù„ØªÙØ§ØµÙŠÙ„";
        text-align: center;
        width: 100%;
      }
      #rows td.mobile-details-toggle::after {
        content: "";
      }
      #rows td.mobile-details-input,
      #rows td.mobile-details-toggle {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }
      #rows td.mobile-details-input button,
      #rows td.mobile-details-toggle button {
        padding: 8px 10px;
        -webkit-appearance: none;
        appearance: none;
      }
      #rows td.mobile-details-panel {
        grid-area: detailsPanel;
        border: 1px dashed rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        width: 100%;
        transition: all 0.25s ease-in-out;
        visibility: hidden;
        opacity: 0;
        max-height: 0;
        padding: 0 10px;
        overflow: hidden;
        min-height: 0;
      }
      #rows td.mobile-details-panel.visible {
        visibility: visible;
        opacity: 1;
        max-height: none;
        padding: 10px;
        min-height: 120px;
      }
      #rows td.mobile-details-panel .placeholder {
        opacity: .8;
        font-size: .95rem;
        text-align: center;
        padding: 4px 0;
      }
      #rows td.mobile-details-panel .details-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      #rows td.mobile-details-panel .detail-item {
        display: grid;
        grid-template-columns: 1fr 9ch 34px;
        gap: 8px;
        align-items: center;
      }
      #rows td.mobile-details-panel .detail-item input[type="text"] {
        width: 100%;
      }
      #rows td.mobile-details-panel .detail-item input[data-role="value"] {
        width: 9ch;
        max-width: 9ch;
        text-align: end;
        direction: ltr;
      }
      #rows td.mobile-details-panel .detail-item button.del {
        background: #c0392b;
        color: #fff;
        border: none;
        border-radius: 8px;
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1rem;
      }
      #rows td .mobile-status-text {
        margin-top: 2px;
        font-size: .9rem;
        text-align: center;
      }
      #rows td .mobile-status-text.ok {
        color: #2ecc71;
      }
      #rows td .mobile-status-text.over {
        color: #e74c3c;
      }
      #rows td .mobile-status-text.neutral {
        color: #ddd;
      }
      #rows tr * {
        min-width: 0;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ’° Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</h1>

  <div class="card">
    <div class="row">
      <div style="flex:1 1 200px">
        <label>Ø§Ù„Ø³Ù†Ø©</label>
        <input id="year-input" type="number" />
      </div>
      <div style="flex:1 1 220px">
        <label>Ø§Ù„Ø´Ù‡Ø± (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
        <select id="month-select">
          <option value="01">ÙŠÙ†Ø§ÙŠØ±</option><option value="02">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="03">Ù…Ø§Ø±Ø³</option>
          <option value="04">Ø£Ø¨Ø±ÙŠÙ„</option><option value="05">Ù…Ø§ÙŠÙˆ</option><option value="06">ÙŠÙˆÙ†ÙŠÙˆ</option>
          <option value="07">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="08">Ø£ØºØ³Ø·Ø³</option><option value="09">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
          <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="save-template" class="primary">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨</button>
      <div style="flex:1 1 260px">
        <label>Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</label>
        <div class="row">
          <select id="templates-select" style="flex:1 1 220px"></select>
          <button id="apply-template" class="ghost">ØªØ·Ø¨ÙŠÙ‚</button>
          <button id="delete-template" class="danger">Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨</button>
        </div>
      </div>
      <button id="close-month" class="primary">ğŸ“¦ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ù‡Ø± ÙˆØ­ÙØ¸Ù‡</button>
      <button id="reset" class="danger">ØªÙØ±ÙŠØº Ø§Ù„ÙƒÙ„</button>
      <button id="export-history" class="ghost">ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ JSON</button>
      <button id="export-csv" class="ghost">ØªØµØ¯ÙŠØ± CSV</button>
      <input type="file" id="import-history" accept="application/json" style="display:none" />
      <button id="import-history-btn" class="ghost">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ø±Ø´ÙŠÙ</button>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ’µ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±Ø§ØªØ¨)</h3>
    <div class="row" style="align-items:flex-end">
      <div style="flex:1 1 260px">
        <label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
        <input id="salary2" type="number" placeholder="" />
      </div>
    </div>
  </div>

  <div class="card">
    <h3>â• Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</h3>
    <label>Ø§Ø³Ù… Ø§Ù„Ø¯Ø®Ù„</label>
    <input id="extra-name" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù…Ù„ Ø¥Ø¶Ø§ÙÙŠ" />
    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯Ø®Ù„</label>
    <input id="extra-amount" type="number" />
    <button id="add-extra" class="primary" style="margin-top:10px">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø®Ù„</button>
    <table class="main-table" id="extras-table">
      <thead>
        <tr>
          <th>Ø¯Ø®Ù„</th>
          <th class="col-paid">Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="extras-rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>ğŸ§¾ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
    <label>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
    <div class="row" style="gap:8px">
      <select id="name" style="flex:1 1 220px">
        <option>Ø³ÙƒÙ†</option><option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>Ù…Ø§Ø¡</option><option>Ø¥Ù†ØªØ±Ù†Øª</option><option>ØºØ§Ø²</option><option>Ø§ØªØµØ§Ù„Ø§Øª</option>
        <option>Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª</option><option>Ù…Ø·Ø§Ø¹Ù…</option><option>ØªØ±ÙÙŠÙ‡</option><option>ÙˆÙ‚ÙˆØ¯</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option><option>ØªØ¹Ù„ÙŠÙ…</option>
        <option>ØµØ­Ø©</option><option>Ù…Ù„Ø§Ø¨Ø³</option><option>Ù‡Ø¯Ø§ÙŠØ§</option><option>Ø¬Ù…Ø¹ÙŠØ©</option><option>Ø£Ù‚Ø³Ø§Ø·</option><option>ØµØ¯Ù‚Ø§Øª</option><option>Ø£Ø®Ø±Ù‰</option>
      </select>
      <input id="name-custom" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù„Ùˆ Ø§Ø®ØªØ±Øª (Ø£Ø®Ø±Ù‰)" style="flex:1 1 220px" />
      <button id="save-custom-cat" class="ghost">ğŸ’¾ Ø­ÙØ¸ ÙƒØ®ÙŠØ§Ø± Ø¯Ø§Ø¦Ù…</button>
      <button id="delete-cat" class="danger">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</button>
    </div>
    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®Ø·Ø·</label><input id="planned" type="number" />
    <label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</label><input id="paid" type="number" />
    <button id="add" type="button" class="primary" style="margin-top:12px">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
    <table class="main-table" id="rows">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th class="col-planned">Ø§Ù„Ù…Ø®Ø·Ø·</th><th class="col-paid">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th class="col-due">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <!-- âœ¨ Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ âœ¨ -->
    <button id="save-all-changes" class="primary" style="width: 100%; margin-top: 15px; padding: 12px; font-size: 1.1rem;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <div class="totals">
      <div><div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø·Ø·</div><h3 id="t_planned">0</h3></div>
      <div><div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><h3 id="t_paid">0</h3></div>
      <div><div class="pill">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯</div><h3 id="t_due">0</h3></div>
      <div><div class="pill">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div><h3 id="t_balance">0</h3></div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“ˆ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</h3>
    <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø³ØªÙ‚Ù„Ø© ØªÙ…Ø§Ù…Ù‹Ø§ ÙˆÙ„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø£Ùˆ Ø§Ù„Ø£Ø±ØµØ¯Ø©.</p>
    <div class="row">
      <div style="flex:1 1 220px">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</label><input id="inv-type" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø³Ù‡Ù…ØŒ Ø¨ÙŠØªÙƒÙˆÙŠÙ†ØŒ Ø¹Ù‚Ø§Ø±" />
      </div>
      <div style="flex:1 1 220px">
        <label>Ø§Ù„ÙˆØ¬Ù‡Ø© / Ø£ÙŠÙ† Ø°Ù‡Ø¨Øª Ø§Ù„Ø£Ù…ÙˆØ§Ù„</label><input id="inv-dest" placeholder="Ù…Ø«Ø§Ù„: TeslaØŒ BTC WalletØŒ ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø¤Ø´Ø±" />
      </div>
      <div style="flex:1 1 180px">
        <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)</label><input id="inv-amount" type="number" />
      </div>
      <div style="flex:1 1 220px">
        <label>Ù…ØµØ¯Ø± Ø§Ù„Ø£Ù…ÙˆØ§Ù„</label><input id="inv-source" placeholder="Ø±Ø§ØªØ¨ØŒ Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠØŒ Ø³Ø­Ø¨ Ù…Ù† Ø§Ø¯Ø®Ø§Ø±..." />
      </div>
    </div>
    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª / ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <textarea id="inv-notes" placeholder="ØªÙØ§ØµÙŠÙ„ Ù…Ø«Ù„: Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„ÙˆØ³ÙŠØ·ØŒ Ø±Ø³ÙˆÙ…..."></textarea>
    <button id="add-inv" class="primary" style="margin-top:12px">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ«Ù…Ø§Ø±</button>
    <table class="main-table" id="investments-table">
      <thead>
        <tr>
          <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th class="col-paid">Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="inv-rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>ğŸ“š Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
    <div class="row" style="margin-bottom:10px">
      <div style="flex:1 1 220px">
        <label>Ø§Ø®ØªØ± Ø´Ù‡Ø±Ù‹Ø§</label><select id="history-select"></select>
      </div>
      <button id="delete-month" class="danger">Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
    <div id="history-kpis" class="totals"></div>
    <div id="history-table-wrap"></div>
    <div id="history-chart-wrap"><canvas id="history-chart"></canvas></div>
    <div id="delta-chart-wrap"><canvas id="delta-chart"></canvas></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const STORE_KEY = 'budget-mini-v5';
    const HISTORY_KEY = 'budget-history-v5';
    const TEMPLATES_KEY = 'budget-templates-v4';
    const CATS_KEY = 'budget-custom-cats-v1';
    const DELETED_CATS_KEY = 'budget-deleted-cats-v1';
    let state = {
      salary: 0,
      items: [],
      extras: [],
      investments: []
    };
    const legacyStoreV4 = JSON.parse(localStorage.getItem('budget-mini-v4') || 'null');
    if (!localStorage.getItem(STORE_KEY) && legacyStoreV4) {
      state = { ...legacyStoreV4,
        investments: legacyStoreV4.investments || []
      };
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }

    function ensureSelectPopulated(id, fillerFn, fallbackBuilder) {
      const sel = $(id);
      let tries = 0;
      const tick = () => {
        tries++;
        try {
          if (sel && sel.options && sel.options.length === 0) {
            if (typeof fillerFn === 'function') fillerFn();
          }
          if (sel && sel.options && sel.options.length === 0 && typeof fallbackBuilder === 'function') {
            const opts = fallbackBuilder();
            if (Array.isArray(opts) && opts.length) {
              opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.text;
                sel.appendChild(opt);
              });
            }
          }
        } catch (e) {}
        if (sel && sel.options && sel.options.length === 0 && tries < 6) {
          setTimeout(tick, 200);
        }
      };
      setTimeout(tick, 120);
    }

    function runEnsures() {
      ensureSelectPopulated('month-select', fillMonths, () => [{
        value: '01',
        text: 'ÙŠÙ†Ø§ÙŠØ±'
      }, {
        value: '02',
        text: 'ÙØ¨Ø±Ø§ÙŠØ±'
      }, {
        value: '03',
        text: 'Ù…Ø§Ø±Ø³'
      }, {
        value: '04',
        text: 'Ø£Ø¨Ø±ÙŠÙ„'
      }, {
        value: '05',
        text: 'Ù…Ø§ÙŠÙˆ'
      }, {
        value: '06',
        text: 'ÙŠÙˆÙ†ÙŠÙˆ'
      }, {
        value: '07',
        text: 'ÙŠÙˆÙ„ÙŠÙˆ'
      }, {
        value: '08',
        text: 'Ø£ØºØ³Ø·Ø³'
      }, {
        value: '09',
        text: 'Ø³Ø¨ØªÙ…Ø¨Ø±'
      }, {
        value: '10',
        text: 'Ø£ÙƒØªÙˆØ¨Ø±'
      }, {
        value: '11',
        text: 'Ù†ÙˆÙÙ…Ø¨Ø±'
      }, {
        value: '12',
        text: 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
      }, ]);
      ensureSelectPopulated('name', refreshCats, () => (defaultCats || []).map(c => ({
        value: c,
        text: c
      })));
      ensureSelectPopulated('templates-select', refreshTemplates, () => [{
        value: '',
        text: 'â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ â€”'
      }]);
      ensureSelectPopulated('history-select', refreshHistorySelect, () => [{
        value: '',
        text: 'â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ø´ÙŠÙ â€”'
      }]);
    }

    function ensureCatsRetries() {
      const sel = $('name');
      let attempts = 0;
      const tick = () => {
        attempts++;
        if (sel && sel.options && sel.options.length === 0) {
          try {
            refreshCats();
          } catch (e) {}
        }
        if (sel && sel.options && sel.options.length === 0 && attempts < 5) {
          setTimeout(tick, 200);
        }
      };
      setTimeout(tick, 150);
    }
    let budgetHistory = load(HISTORY_KEY) || {};
    const legacyHistoryV4 = JSON.parse(localStorage.getItem('budget-history-v4') || 'null');
    if (!Object.keys(budgetHistory).length && legacyHistoryV4) {
      budgetHistory = legacyHistoryV4;
      save(HISTORY_KEY, budgetHistory);
    }
    let templates = load(TEMPLATES_KEY) || {};
    let customCats = load(CATS_KEY) || [];
    let deletedCats = load(DELETED_CATS_KEY) || [];
    let historyChart = null,
      deltaChart = null;

    function load(key) {
      try {
        return JSON.parse(localStorage.getItem(key) || 'null')
      } catch {
        return null
      }
    }

    function save(key, val) {
      localStorage.setItem(key, JSON.stringify(val))
    }

    function persist() {
      save(STORE_KEY, state)
    }
    
    // âœ¨ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠ âœ¨
    function saveAllChanges() {
        persist();
        alert('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª âœ…');
    }

    function normalizeCat(s) {
      return (s || '').trim().replace(/\s+/g, ' ');
    }

    function monthNow() {
      const d = new Date();
      const m = (d.getMonth() + 1).toString().padStart(2, '0');
      return `${d.getFullYear()}-${m}`;
    }
    const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];

    function fillMonths() {
      const sel = $('month-select');
      sel.innerHTML = '';
      months.forEach((m, i) => {
        const v = (i + 1).toString().padStart(2, '0');
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    }

    function currentMonthName() {
      try {
        const idx = Math.max(0, (parseInt($('month-select').value || (new Date().getMonth() + 1), 10) - 1));
        return months[idx] || '';
      } catch {
        return '';
      }
    }
    const defaultCats = ['Ø³ÙƒÙ†', 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'Ù…Ø§Ø¡', 'Ø¥Ù†ØªØ±Ù†Øª', 'ØºØ§Ø²', 'Ø§ØªØµØ§Ù„Ø§Øª', 'Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª', 'Ù…Ø·Ø§Ø¹Ù…', 'ØªØ±ÙÙŠÙ‡', 'ÙˆÙ‚ÙˆØ¯', 'Ù…ÙˆØ§ØµÙ„Ø§Øª', 'ØªØ¹Ù„ÙŠÙ…', 'ØµØ­Ø©', 'Ù…Ù„Ø§Ø¨Ø³', 'Ù‡Ø¯Ø§ÙŠØ§', 'Ø¬Ù…Ø¹ÙŠØ©', 'Ø£Ù‚Ø³Ø§Ø·', 'ØµØ¯Ù‚Ø§Øª', 'Ø£Ø®Ø±Ù‰'];

    function visibleCats() {
      const delSet = new Set((deletedCats || []).map(normalizeCat));
      return [...new Set([...defaultCats, ...customCats])].filter(c => !delSet.has(normalizeCat(c)));
    }

    function refreshCats() {
      const sel = $('name');
      sel.innerHTML = '';
      let cats = visibleCats();
      if (!Array.isArray(cats) || cats.length === 0) {
        cats = [...defaultCats];
      }
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      sel.value = cats.includes('Ø£Ø®Ø±Ù‰') ? 'Ø£Ø®Ø±Ù‰' : (cats[0] || '');
    }

    function addCustomCatIfNeeded(nameRaw) {
      const name = normalizeCat(nameRaw);
      if (!name || name === 'Ø£Ø®Ø±Ù‰') return;
      if (!customCats.map(normalizeCat).includes(name)) {
        customCats.push(name);
        save(CATS_KEY, customCats);
      }
      deletedCats = (deletedCats || []).map(normalizeCat).filter(d => d !== name);
      save(DELETED_CATS_KEY, deletedCats);
      refreshCats();
      $('name').value = name;
    }

    function deleteSelectedCat() {
      const c = normalizeCat($('name').value);
      if (!c) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø© Ù…Ø­Ø¯Ø¯Ø©');
        return;
      }
      if (c === 'Ø£Ø®Ø±Ù‰') {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù ÙØ¦Ø© "Ø£Ø®Ø±Ù‰"');
        return;
      }
      if (!(deletedCats || []).map(normalizeCat).includes(c)) {
        deletedCats.push(c);
      }
      save(DELETED_CATS_KEY, deletedCats);
      refreshCats();
      alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© "${c}" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ù„Ø§ ØªØªØ£Ø«Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙØ¶Ø§ÙØ© Ø³Ø§Ø¨Ù‚Ù‹Ø§.`);
    }

    function statusOf(i) {
      if ((+i.paid || 0) >= (+i.planned || 0) && (+i.planned || 0) > 0) return {
        text: 'Ù…Ø¯ÙÙˆØ¹',
        cls: 'Ù…Ø¯ÙÙˆØ¹'
      };
      if ((+i.paid || 0) > 0 && (+i.paid || 0) < (+i.planned || 0)) return {
        text: 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠ',
        cls: 'Ù…Ø¯ÙÙˆØ¹-Ø¬Ø²Ø¦ÙŠ'
      };
      return {
        text: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
        cls: 'ØºÙŠØ±-Ù…Ø¯ÙÙˆØ¹'
      };
    }

    function updateTotals() {
      let tPlanned = 0,
        tPaid = 0;
      state.items.forEach(i => {
        tPlanned += (+i.planned || 0);
        tPaid += (+i.paid || 0);
      });
      const extrasSum = state.extras.reduce((a, e) => a + (+e.amount || 0), 0);
      $('t_planned').textContent = tPlanned;
      $('t_paid').textContent = tPaid;
      $('t_due').textContent = Math.max(0, tPlanned - tPaid);
      $('t_balance').textContent = (+state.salary || 0) + extrasSum - tPaid;
      const sal2 = $('salary2');
      if (sal2) sal2.value = state.salary ? state.salary : '';
    }

    function renderExpenses() {
      const tb = $('rows').querySelector('tbody');
      tb.innerHTML = '';
      state.items.forEach((it, index) => {
        const st = statusOf(it);
        const tr = document.createElement('tr');
        tr.dataset.index = index;
        tr.innerHTML = `
          <td><input type="text" value="${it.name||''}" class="name-input"></td>
          <td class="col-planned"><input type="number" value="${it.planned||0}" class="planned-input"></td>
          <td class="col-paid"><input type="number" value="${it.paid||0}" class="paid-input"></td>
          <td class="col-due due">${Math.max(0,(+it.planned||0)-(+it.paid||0))}</td>
          <td class="status ${st.cls}">${st.text}</td>
          <td>
            <div class="action-buttons">
              <button class="primary pay-one">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>
              <button class="danger del">Ø­Ø°Ù</button>
            </div>
            <button class="ghost sub-btn" style="display:none;">â• ØªÙØµÙŠÙ„</button>
          </td>
        `;
        const nameInp = tr.querySelector('.name-input');
        const pInp = tr.querySelector('.planned-input');
        const paInp = tr.querySelector('.paid-input');
        const dueCell = tr.querySelector('.due');
        const statusCell = tr.querySelector('.status');
        const payBtn = tr.querySelector('.pay-one');
        const delBtn = tr.querySelector('.del');
        const subBtn = tr.querySelector('.sub-btn');
        if (!it.subItems) it.subItems = [];

        function refreshRow() {
          const st = statusOf(it);
          dueCell.textContent = Math.max(0, (+it.planned || 0) - (+it.paid || 0));
          statusCell.textContent = st.text;
          statusCell.className = 'status ' + st.cls;
          updateTotals(); // âœ¨ ØªÙ… Ø­Ø°Ù persist()
        }
        nameInp.addEventListener('input', e => {
          it.name = normalizeCat(e.target.value); // âœ¨ ØªÙ… Ø­Ø°Ù persist()
        });
        pInp.addEventListener('input', e => {
          it.planned = +e.target.value || 0;
          refreshRow();
        });
        paInp.addEventListener('input', e => {
          it.paid = +e.target.value || 0;
          refreshRow();
        });
        payBtn.addEventListener('click', () => {
          it.paid = +it.planned || 0;
          paInp.value = it.paid;
          refreshRow();
          persist(); // âœ¨ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø§ ØªØ²Ø§Ù„ ØªØ­ÙØ¸ ÙÙˆØ±Ø§Ù‹
        });
        delBtn.addEventListener('click', () => {
          state.items = state.items.filter(x => x !== it);
          renderExpenses();
          updateTotals();
          persist(); // âœ¨ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø°Ù Ù„Ø§ ØªØ²Ø§Ù„ ØªØ­ÙØ¸ ÙÙˆØ±Ø§Ù‹
        });
        tb.appendChild(tr);
        // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...
      });
    }

    function renderExtras() {
      const tb = $('extras-rows');
      tb.innerHTML = '';
      state.extras.forEach((ex, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ex.name}</td>
          <td class="col-paid"><input type="number" value="${ex.amount||0}" class="extra-amount-input"></td>
          <td><button class="danger del-extra">Ø­Ø°Ù</button></td>
        `;
        const amountInp = tr.querySelector('.extra-amount-input');
        const delBtn = tr.querySelector('.del-extra');
        amountInp.addEventListener('input', e => {
          ex.amount = +e.target.value || 0;
          updateTotals(); // âœ¨ ØªÙ… Ø­Ø°Ù persist()
        });
        delBtn.addEventListener('click', () => {
          state.extras.splice(idx, 1);
          renderExtras();
          updateTotals();
          persist();
        });
        tb.appendChild(tr);
      });
    }

    function renderInvestments() {
      const tb = $('inv-rows');
      if (!tb) return;
      tb.innerHTML = '';
      state.investments.forEach((inv, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" value="${inv.type||''}" class="inv-type-input"></td>
          <td><input type="text" value="${inv.dest||''}" class="inv-dest-input"></td>
          <td class="col-paid"><input type="number" value="${inv.amount||0}" class="inv-amount-input"></td>
          <td><input type="text" value="${inv.source||''}" class="inv-source-input"></td>
          <td><input type="text" value="${inv.addedMonth||''}" class="inv-month-input" readonly></td>
          <td><textarea class="inv-notes-input" style="min-height:48px">${inv.notes||''}</textarea></td>
          <td><button class="danger del-inv">Ø­Ø°Ù</button></td>
        `;
        tr.querySelector('.inv-type-input').addEventListener('input', e => { inv.type = normalizeCat(e.target.value); });
        tr.querySelector('.inv-dest-input').addEventListener('input', e => { inv.dest = normalizeCat(e.target.value); });
        tr.querySelector('.inv-amount-input').addEventListener('input', e => { inv.amount = +e.target.value || 0; });
        tr.querySelector('.inv-source-input').addEventListener('input', e => { inv.source = normalizeCat(e.target.value); });
        tr.querySelector('.inv-notes-input').addEventListener('input', e => { inv.notes = e.target.value; });
        tr.querySelector('.del-inv').addEventListener('click', () => {
          state.investments.splice(idx, 1);
          renderInvestments();
          persist();
        });
        tb.appendChild(tr);
      });
    }

    function addInvestment() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø£Ù†Ù‡ ÙŠØ­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      persist();
    }

    function addItem() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø£Ù†Ù‡ ÙŠØ­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      persist();
    }

    function saveCurrentAsTemplate() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...
    }

    function refreshTemplates() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...
    }

    function applyTemplate() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø£Ù†Ù‡ ÙŠØ­ÙØ¸ Ø¹Ù†Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨
      persist();
    }

    function deleteTemplate() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...
    }

    function addExtra() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø£Ù†Ù‡ ÙŠØ­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      persist();
    }

    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø­ØªÙ‰ bind() ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ...

    function bind() {
      function syncSalary(val) {
        state.salary = +val || 0;
        updateTotals(); // âœ¨ ØªÙ… Ø­Ø°Ù persist()
      }
      const sal2 = $('salary2');
      if (sal2) sal2.addEventListener('input', e => syncSalary(e.target.value));
      
      $('save-custom-cat').addEventListener('click', ()=>{
        const custom = normalizeCat($('name-custom').value||'');
        if(!custom){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
        addCustomCatIfNeeded(custom);
        $('name-custom').value='';
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø© Ø¶Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª âœ…');
      });
      $('delete-cat').addEventListener('click', deleteSelectedCat);
      
      $('add').addEventListener('click', addItem);
      $('add-extra').addEventListener('click', addExtra);
      $('add-inv').addEventListener('click', addInvestment);
      
      $('save-template').addEventListener('click', saveCurrentAsTemplate);
      $('apply-template').addEventListener('click', applyTemplate);
      $('delete-template').addEventListener('click', deleteTemplate);
      
      $('close-month').addEventListener('click', closeMonth);
      $('history-select').addEventListener('change', ()=>{ renderHistory(); });
      $('delete-month').addEventListener('click', deleteSelectedMonth);
      
      $('reset').addEventListener('click', ()=>{ if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ±ÙŠØºØŸ')){ state={salary:0,items:[],extras:[],investments:[]}; renderExpenses(); renderExtras(); renderInvestments(); updateTotals(); persist(); } });
      
      $('export-history').addEventListener('click', exportHistoryJSON);
      $('export-csv').addEventListener('click', exportCSV);
      $('import-history-btn').addEventListener('click', ()=> $('import-history').click());
      $('import-history').addEventListener('change', importHistory);
      
      // âœ¨ Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© âœ¨
      $('save-all-changes').addEventListener('click', saveAllChanges);
    }
    
    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ...

    function init() {
      // ... Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...
      bind();
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <script id="mobile-v29-enhance">
    (function() {
      if (window.__mobileEnhanceV29Installed) return;
      window.__mobileEnhanceV29Installed = true;

      function saveSubItemsToState(tr) {
          if (!tr) return;
          var index = parseInt(tr.dataset.index, 10);
          if (isNaN(index) || !state.items[index]) {
              return;
          }
          var panel = tr.querySelector('td.mobile-details-panel');
          if (!panel) return;
          var subItems = [];
          var detailItems = panel.querySelectorAll('.detail-item');
          detailItems.forEach(function(item) {
              var nameInput = item.querySelector('input[type="text"]');
              var valueInput = item.querySelector('input[data-role="value"]');
              var name = (nameInput.value || '').trim();
              var amount = parseFloat(valueInput.value || 0);
              if (name || amount > 0) {
                  subItems.push({ name: name, amount: amount });
              }
          });
          state.items[index].subItems = subItems;
          // âœ¨ ØªÙ… Ø­Ø°Ù persist()
      }

      function createSubItemElements(subItem, tr) {
          var itemEl = document.createElement('div');
          itemEl.className = 'detail-item';
          var name = document.createElement('input');
          name.type = 'text';
          name.placeholder = 'Ø§Ø³Ù… Ø§Ù„ØªÙØµÙŠÙ„';
          name.value = subItem.name || '';
          name.addEventListener('input', function() { saveSubItemsToState(tr); });
          var value = document.createElement('input');
          value.type = 'number';
          value.setAttribute('data-role', 'value');
          value.placeholder = 'Ø§Ù„Ù‚ÙŠÙ…Ø©';
          value.value = subItem.amount || '';
          value.addEventListener('input', function() {
              updatePaidFromPanel(tr);
              saveSubItemsToState(tr);
          });
          var del = document.createElement('button');
          del.type = 'button';
          del.className = 'del';
          del.textContent = 'Ã—';
          del.addEventListener('click', function() {
              itemEl.remove();
              updatePaidFromPanel(tr);
              saveSubItemsToState(tr);
          });
          itemEl.appendChild(name);
          itemEl.appendChild(value);
          itemEl.appendChild(del);
          return itemEl;
      }

      function loadSubItemsIntoPanel(tr) {
          var index = parseInt(tr.dataset.index, 10);
          if (isNaN(index) || !state.items[index] || !state.items[index].subItems) return;
          var itemData = state.items[index];
          if (itemData.subItems.length > 0) {
              var panel = ensurePanel(tr);
              var list = panel.querySelector('.details-list');
              list.innerHTML = '';
              itemData.subItems.forEach(function(subItem) {
                  var subItemEl = createSubItemElements(subItem, tr);
                  list.appendChild(subItemEl);
              });
              panel.querySelector('.placeholder').style.display = 'none';
          }
      }

      function ensurePanel(tr) {
        var panel = tr.querySelector('td.mobile-details-panel');
        if (!panel) {
          panel = document.createElement('td');
          panel.className = 'mobile-details-panel';
          var list = document.createElement('div');
          list.className = 'details-list';
          panel.appendChild(list);
          var ph = document.createElement('div');
          ph.className = 'placeholder';
          ph.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ØªÙØµÙŠÙ„ÙŠØ©';
          panel.appendChild(ph);
          tr.appendChild(panel);
        }
        return panel;
      }

      function updatePaidFromPanel(tr) {
        var panel = tr.querySelector('td.mobile-details-panel');
        if (!panel) return;
        var vals = panel.querySelectorAll('.detail-item input[data-role="value"]');
        var sum = 0;
        vals.forEach(function(inp) {
          var v = parseFloat((inp.value || '').replace(/,/g, ''));
          if (!isNaN(v)) sum += v;
        });
        var paidInput = tr.querySelector('td:nth-child(3) input');
        if (paidInput) {
          paidInput.value = sum || 0;
        }
        var index = parseInt(tr.dataset.index, 10);
        if(!isNaN(index) && state.items[index]){
          state.items[index].paid = sum;
          updateTotals();
          // âœ¨ ØªÙ… Ø­Ø°Ù persist()
        }
        updateStatus(tr);
      }

      function addDetailItem(tr) {
        if (tr.dataset.detailLock === '1') return;
        tr.dataset.detailLock = '1';
        setTimeout(function() {
          tr.dataset.detailLock = '0';
        }, 300);
        var panel = ensurePanel(tr);
        panel.classList.add('visible');
        var list = panel.querySelector('.details-list');
        var newSubItemEl = createSubItemElements({name: '', amount: ''}, tr);
        list.appendChild(newSubItemEl);
        panel.querySelector('.placeholder').style.display = 'none';
        updatePaidFromPanel(tr);
        saveSubItemsToState(tr);
      }
      
      // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...

      function enhanceRow(tr) {
        if (!tr || tr.getAttribute('data-mobile-enhanced') === '1') return;
        var tds = tr.querySelectorAll('td');
        if (tds.length < 6) return;
        hideLegacyButtons(tr);
        var addCell = document.createElement('td');
        addCell.className = 'mobile-details-input';
        var addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn';
        addBtn.textContent = 'ØªÙØµÙŠÙ„ +';
        addBtn.addEventListener('click', function() {
          addDetailItem(tr);
        });
        addCell.appendChild(addBtn);
        var toggleCell = document.createElement('td');
        toggleCell.className = 'mobile-details-toggle';
        var toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'btn';
        toggleBtn.textContent = 'Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡';
        toggleBtn.addEventListener('click', function() {
          var panel = ensurePanel(tr);
          panel.classList.toggle('visible');
        });
        toggleCell.appendChild(toggleBtn);
        ensurePanel(tr);
        tr.appendChild(addCell);
        tr.appendChild(toggleCell);
        wireInputs(tr);
        loadSubItemsIntoPanel(tr);
        tr.setAttribute('data-mobile-enhanced', '1');
      }

      // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ...
      
      function install() {
        if (!window.matchMedia || !window.matchMedia('(max-width: 430px)').matches) return;
        patchAddButton();
        enhanceAll();
        hideHeader();
        var tableBody = document.getElementById('rows').querySelector('tbody');
        if (tableBody) {
          var obs = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.addedNodes.length) {
                enhanceAll();
              }
            });
          });
          obs.observe(tableBody, {
            childList: true
          });
        }
        document.documentElement.style.overflowX = 'hidden';
        document.body.style.overflowX = 'hidden';
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', install, {
          once: true
        });
      } else {
        install();
      }
    })();
  </script>
</body>
</html>

